<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/style.css">
    <script src="p5.min.js"></script>
    <script src="script.js"></script>
    <script src="webcam.js"></script>
    <title>Kontrol</title>
</head>
<body>
    <div class="container">
		<div class="parent" id = "parent">
			<div class="topBar">  </div>
			<div class="title"> <h1>Kontrol</h1> </div>
			<div class="windowButtons">
				<div class = "buttons">
					<button id = "minimise">
						<svg viewBox="0 0 6 6" xmlns="http://www.w3.org/2000/svg">
							<line x1="1" y1="3" x2="5" y2="3" stroke="black"
								  stroke-linecap="round" />
						</svg>
					</button>
					<button id = "closeButton">
						<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18.3 5.71c-.39-.39-1.02-.39-1.41 0L12 10.59 7.11 5.7c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L10.59 12 5.7 16.89c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>
					</button>
				</div>
            </div>
            <div id = "inserted">
                <div class = "leftPanel">
                    <ul class = "panelList">
                        <li tabindex="0" id = "gestures" class="selected"><img class = "wifi" src="images/wave.svg" draggable="false"><h2>Gestures</h2></li>
                        <li tabindex="0" id = "connection "><img class = "wifi" src="images/wifi.svg" draggable="false"><h2>Connection</h2></li>
                        <li tabindex="0" id = "settings"><img class = "wifi" src="images/settings.svg" draggable="false"><h2>Settings</h2></li>
                        <li tabindex="0" id = "help"><img class = "wifi" src="images/help.svg" draggable="false"><h2>Help</h2></li>
                    </ul>
                </div>

                <div class="centrePanel" id = "centre">
                    <h1 class="bigTitle" id = "title">Gestures</h1>

                    <h2>Copy the poses as they appear.</h2>
                    <p>You can practice each gesture as many times as you like, just choose another from the list on the right when you're ready to move on.</p>
                    
                </div>
                <div class = "rightPanel">
                    <ul class = "panelList">
                        <li id = "playPause" tabindex="0" class="selected"><img class = "wifi" src="images/pause.svg" draggable="false"><h2>Play/Ok</h2></li>
                        <li id = "rewind" tabindex="0"><img class = "wifi" src="images/rewind.svg" draggable="false"><h2>Rewind</h2></li>
                        <li id = "fastForward" tabindex="0"><img class = "wifi" src="images/fast-forward.svg" draggable="false"><h2>Fast Forward</h2></li>
                        <li id = "goPrevious" tabindex="0"><img class = "wifi" src="images/back.svg" draggable="false"><h2>Previous</h2></li>
                        <li id = "goNext" tabindex="0"><img class = "wifi" src="images/next.svg" draggable="false"><h2>Next</h2></li>
                        <li id = "volumeDown" tabindex="0"><img class = "wifi" src="images/volume_down-24px.svg" draggable="false"><h2>Volume Down</h2></li>
                        <li id = "volumeUp" tabindex="0"><img class = "wifi" src="images/volume_up-24px.svg" draggable="false"><h2>Volume Up</h2></li>
                        <li id = "mute" tabindex="0"><img class = "wifi" src="images/volume_off-24px.svg" draggable="false"><h2>Mute/Unmute</h2></li>

                    </ul>
                </div>
            </div>

                <script>
                    const KodiController = require("kodi-controller");
                    kodi = new KodiController("192.168.0.135");

                    function rewind(){
                        kodi.rewind();
                    }
                    function fastForward(){
                        kodi.fastForward();
                    }
                    function goPrevious(){
                        kodi.rewind();
                    }
                    function goNext(){
                        kodi.goNext();
                    }
                    function playPause(){
                        kodi.playPause();
                    }
                    function volumeUp(){
                        kodi.volumeUp();
                    }
                    function volumeDown(){
                        kodi.volumeDown();
                    }
                    let win = remote.getCurrentWindow();
                    win.setSize(1200, 800);
                    $("body").addClass("big");
                    $("html").addClass("big");

                    $(".leftPanel li").on( "click", function() {
                        $(".leftPanel .selected").toggleClass("selected");
                        $( this ).toggleClass("selected");
                    });

                    $(".rightPanel li").on( "click", function() {
                        $(".rightPanel .selected").toggleClass("selected");
                        $( this ).toggleClass("selected");
                    });

                    // $("body").css("height", 692);
                    // $("html").css("height", 692);

                    const ml5 = require('ml5');

                    let video;
                    let poseNet;
                    let pose;
                    let skeleton;
                    let canvas;

                    let brain;
                    let poseLabel = "";

                    let state = 'waiting';
                    let targetLabel;
                    let lastPoses = []
                    function setItem (array, item, length) {
                       array.unshift(item) > length ?  array.pop() : null
                    }

                    function setup() {
                        canvas = createCanvas(640, 360);
                        video = createCapture(VIDEO);
                        canvas.parent("title");
                        video.hide();
                        poseNet = ml5.poseNet(video, modelLoaded);
                        poseNet.on('pose', gotPoses);

                        let options = {
                            inputs: 34,
                            outputs: 4,
                            task: 'classification',
                            debug: true
                        }
                        brain = ml5.neuralNetwork(options);
                        
                        //   LOAD PRETRAINED MODEL
                        const modelInfo = {
                            model: 'model/model.json',
                            metadata: 'model/model_meta.json',
                            weights: 'model/model.weights.bin'
                        };
                        brain.load(modelInfo, brainLoaded);

                        // LOAD TRAINING DATA
                        // brain.loadData('data.json', dataReady);
                    }

                    function brainLoaded() {
                    console.log('pose classification ready!');
                    classifyPose();
                    }

                    function classifyPose() {
                    if (pose) {
                        let inputs = [];
                        for (let i = 0; i < pose.keypoints.length; i++) {
                        let x = pose.keypoints[i].position.x;
                        let y = pose.keypoints[i].position.y;
                        inputs.push(x);
                        inputs.push(y);
                        }
                        brain.classify(inputs, gotResult);
                    } else {
                        setTimeout(classifyPose, 100);
                    }
                    }
                    function pass(){
                        return;
                    }
                    function gotResult(error, results) {  
                    let kMap = {
                        "Left_arm_up" : rewind,
                        "Right_arm_up" : fastForward,
                        "Left_arm_out" : goPrevious,
                        "Right_arm_out" : goNext,
                        "T_pose" : playPause,
                        "Left_arm_90_up" : volumeDown,
                        "Right_arm_90_up" : volumeUp,
                        "base": pass,
                        "Base": pass
                    }
                    let map = {
                        "Left_arm_up" : "rewind",
                        "Right_arm_up" : "fastForward",
                        "Left_arm_out" : "goPrevious",
                        "Right_arm_out" : "goNext",
                        "T_pose" : "playPause",
                        "Left_arm_90_up" : "volumeDown",
                        "Right_arm_90_up" : "volumeUp"
                    }
                    $(".greenBG").removeClass("greenBG");
                    if (results[0].confidence > 0.75) {
                        setItem(lastPoses, results[0].label, 5);
                        if(lastPoses.every((i) => {return i == lastPoses[0]})){
                            console.log("#"+map[results[0].label]);                        
                            $("#"+map[results[0].label]).addClass("greenBG");  
                            try{
                                kMap[results[0].label]();
                            }
                            catch(e){
                                console.log(e);
                            }
                            setTimeout(classifyPose, 1000);
                        }else{
                            classifyPose();
                        }
                             
                        

                    }else{
                      classifyPose();
                    }
                    
                    }


                    function gotPoses(poses) {
                    // console.log(poses); 
                    if (poses.length > 0) {
                        pose = poses[0].pose;
                        skeleton = poses[0].skeleton;
                        if (state == 'collecting') {
                        let inputs = [];
                        for (let i = 0; i < pose.keypoints.length; i++) {
                            let x = pose.keypoints[i].position.x;
                            let y = pose.keypoints[i].position.y;
                            inputs.push(x);
                            inputs.push(y);
                        }
                        let target = [targetLabel];
                        brain.addData(inputs, target);
                        }
                    }
                    }


                    function modelLoaded() {
                    console.log('poseNet ready');
                    }

                    function draw() {
                    push();
                    translate(video.width, 0);
                    scale(-1, 1);
                    image(video, 0, 0, video.width, video.height);

                    if (pose) {
                        for (let i = 0; i < skeleton.length; i++) {
                        let a = skeleton[i][0];
                        let b = skeleton[i][1];
                        strokeWeight(2);
                        stroke(0);

                        line(a.position.x, a.position.y, b.position.x, b.position.y);
                        }
                        for (let i = 5; i < pose.keypoints.length; i++) {
                        let x = pose.keypoints[i].position.x;
                        let y = pose.keypoints[i].position.y;
                        fill(0);
                        if(state == "collecting"){
                            fill(255, 0,0);
                        }
                        stroke(255);
                        ellipse(x, y, 16, 16);
                        }
                    }
                    pop();

                    fill(255, 0, 255);
                    noStroke();
                    textSize(32);
                    textAlign(CENTER, CENTER);
                    text(poseLabel, width / 2, height - 20);
                    }
                </script>
        </div>
    </div>
</body>
</html>